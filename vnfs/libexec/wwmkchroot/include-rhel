

REPO_NAME="os-base"

sanity_check() {
    if ! rpm -q yum >/dev/null 2>&1; then
        echo "ERROR: Could not query RPM for YUM"
        return 1
    fi
    return 0
}

prechroot() {

    if [ -n "$OS_MIRROR" ]; then
        YUM_MIRROR="$OS_MIRROR"
    fi

    if [ -z "$YUM_MIRROR" ]; then
        echo "ERROR: You must define the \$YUM_MIRROR variable in the template!"
        exit 1
    fi

    mkdir -m 0755 -p $CHROOTDIR/etc
    mkdir -m 0755 -p $CHROOTDIR/etc/yum.repos.d

    > $CHROOTDIR/etc/yum.conf
    > $CHROOTDIR/etc/yum.repos.d/$REPO_NAME.repo

    echo "[main]" >> $CHROOTDIR/etc/yum.conf
    echo 'cachedir=/var/cache/yum/$basearch/$releasever' >> $CHROOTDIR/etc/yum.conf
    echo "keepcache=0" >> $CHROOTDIR/etc/yum.conf
    echo "debuglevel=2" >> $CHROOTDIR/etc/yum.conf
    echo "logfile=/var/log/yum.log" >> $CHROOTDIR/etc/yum.conf
    echo "exactarch=1" >> $CHROOTDIR/etc/yum.conf
    echo "obsoletes=1" >> $CHROOTDIR/etc/yum.conf
    echo "gpgcheck=0" >> $CHROOTDIR/etc/yum.conf
    echo "plugins=1" >> $CHROOTDIR/etc/yum.conf

    echo "[$REPO_NAME]" >> $CHROOTDIR/etc/yum.repos.d/$REPO_NAME.repo
    echo 'name=Linux $releasever - $basearch' >> $CHROOTDIR/etc/yum.repos.d/$REPO_NAME.repo
    echo "baseurl=$YUM_MIRROR" >> $CHROOTDIR/etc/yum.repos.d/$REPO_NAME.repo
    echo "enabled=1" >> $CHROOTDIR/etc/yum.repos.d/$REPO_NAME.repo
    echo "gpgcheck=0" >> $CHROOTDIR/etc/yum.repos.d/$REPO_NAME.repo

}

buildchroot() {

    if [ -z "$PKGLIST" ]; then
        echo "ERROR: You must define the \$PKGLIST variable in the template!"
        exit 1
    fi

    yum --tolerant --installroot $CHROOTDIR -y install $PKGLIST

    if [ $? -ne 0 ]; then
        echo "ERROR: Failed to create chroot"
        return 1
    fi

    return 0
}

postchroot() {
    touch $CHROOTDIR/fastboot
    if grep -q rename_device $CHROOTDIR/etc/sysconfig/network-scripts/network-functions; then
        echo "" >> $CHROOTDIR/etc/sysconfig/network-scripts/network-functions
        echo "# This is a kludge added by Warewulf so devices don't get renamed (broke things with IB)" >> $CHROOTDIR/etc/sysconfig/network-scripts/network-functions
        echo "rename_device() { return 0; }" >> $CHROOTDIR/etc/sysconfig/network-scripts/network-functions
    fi
    # Disable all other repositories on node except for what we just used to
    # install from. They are still present, but they will require to be
    # activated by hand.
    for i in $CHROOTDIR/etc/yum.repos.d/*.repo; do
        filename=`basename $i`
        if [ "$filename" != "$REPO_NAME.repo" ]; then
            if grep -q "^enabled" $i; then
                sed -i -e 's/^enabled=.*/enabled=0/g' $i
            else
                sed -i -e 's/^\(\[.*\]\)/\1\nenabled=0/' $i
            fi
        fi
    done
    return 0
}



# vim:filetype=sh:syntax=sh:expandtab:ts=4:sw=4:
