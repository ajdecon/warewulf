#!/bin/bash
#
# 
# Copyright (c) 2001-2003 Gregory M. Kurtzer
#
# Copyright (c) 2003-2011, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.
#
# $Id$

SYSCONFDIR=$(wwconfig SYSCONFDIR)

usage() {
    echo "$0 [options] TEMPLATE_NAME PATH"
    echo
    echo "OPTIONS:"
    echo "    -d        Debug output"
    echo "    -h        Usage summary"
    echo
    echo "TEMPLATE_NAME (select one of the following):"
    for i in $SYSCONFDIR/warewulf/wwmkchroot/*.tmpl; do
        NAME=`basename $i | sed -e 's/\.tmpl$//'`
        echo "   $NAME"
    done
    echo
    echo "PATH:"
    echo "   This is the location where the VNFS will be created"
    echo
}


### Argument processing
while getopts "a:dhv" opt; do
    case $opt in
        d)
            VERBOSE=1
            set -x
        ;;
        v)
            VERBOSE=1
        ;;
        h)
            usage
            exit
        ;;
        a)
            var=$OPTARG
        ;;
    esac
done

shift $((OPTIND-1))

export VNFSTEMPLATE=$1
shift
export VNFSDIR=$1
shift


#### Loading templates
test -n "$VERBOSE" && echo "Loading general template"
if [ -f "$SYSCONFDIR/warewulf/wwmkchroot.tmpl" ]; then
    . "$SYSCONFDIR/warewulf/wwmkchroot.tmpl"
    TMPL1_FUNCTIONS=$FUNCTIONS
else
    echo "$0: Error: Can not find $SYSCONFDIR/warewulf/wwmkchroot.tmpl"
    exit 1;
fi

test -n "$VERBOSE" && echo "Loading $VNFSTEMPLATE template"
if [ -f "$SYSCONFDIR/warewulf/wwmkchroot/$VNFSTEMPLATE.tmpl" ]; then
    . "$SYSCONFDIR/warewulf/wwmkchroot/$VNFSTEMPLATE.tmpl"
    TMPL2_FUNCTIONS=$FUNCTIONS
else
    echo "$0: Error: Can not find $SYSCONFDIR/warewulf/wwmkchroot/$VNFSTEMPLATE.tmpl"
    exit 1
fi


#### Running template functions
test -n "$VERBOSE" && echo "Starting template functions"
for function in $TMPL1_FUNCTIONS $TMPL2_FUNCTIONS; do
    test -n "$VERBOSE" && echo "Running: $function"
    $function || exit 1
done




