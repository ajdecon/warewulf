#!/usr/bin/perl -Tw
#
# Copyright (c) 2001-2003 Gregory M. Kurtzer
#
# Copyright (c) 2003-2011, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.
#


use Warewulf::Provision::Include;
use Warewulf::Config;
use Warewulf::Logger;
use Warewulf::Util;
use Getopt::Long;
use File::Path;

Getopt::Long::Configure ("bundling");

my $debug;
my $verbose;
my $rpm;
my $kversion;
my $depmod_map_arg = "";
my $randstring = &rand_string("12");
my $tmpdir = "/var/tmp/wwinitrd.$randstring";
my $wwinitramfs = &wwpath("statedir") ."/warewulf/initramfs.cpio";

%ENV = ();
$ENV{"PATH"} = "/bin:/usr/bin";


GetOptions(
   'd|debug'    => \$debug,
   'v|verbose'  => \$verbose,
   'r|rpm'      => \$rpm,
);

if ($debug) {
    set_log_level("DEBUG");
} elsif ($verbose) {
    set_log_level("WARNINGS");
} else {
    set_log_level("INFO");
}

my $config = Warewulf::Config->new();
my $modules = join(" ", $config->get("drivers"));

if (! -f $wwinitramfs) {
    die "Could not locate the Warewulf CPIO archive at: $wwinitramfs!\n";
}

# Check for depmod option for map files
open(DEPMOD, "/sbin/depmod --help 2>&1 |");
while (my $line = <DEPMOD>) {
    chomp $line;
    if ( $line =~ /^\s*-m\s+/ ) {
        $depmod_map_arg = "-m";
        &nprint("Will use the \"-m\" option to depmod to trigger map file generation\n");
    }
}
close DEPMOD;

if ($rpm) {
    $rpm = $ARGV[0];
    if ($ARGV[0] =~ /^([\/\.\-_a-zA-Z0-9]+\.rpm)$/) {
        $rpm = $1;
        if (-f $rpm) {
            open(RPM, "rpm -qp --qf '%{version}-%{release}' $rpm 2>/dev/null |");
            $kversion = <RPM>;
            close RPM;
        }
        if ($kversion =~ /^([0-9_\.]+\-[a-zA-Z0-9_\..]+)$/) {
            my $kversion_safe = $1;
            &dprint("creating temporary directory at: $tmpdir\n");
            mkpath($tmpdir);
            &iprint("Extracting the kernel modules\n");
            system("rpm2cpio $rpm | (cd $tmpdir; cpio --quiet -id $modules)");
            system("/sbin/depmod $depmod_map_arg -a -b $tmpdir $kversion_safe");

### FIXME: "Capabilities" need to be package up... possibly in CPIO, not left in a dir
### FIXME: structure for RPM to require dependencies for.
            foreach my $module ($config->get("capabilities")) {
                my $path = &wwpath("initramfsdir") . "/" . $module;
                if (-d $path) {
                    &iprint("Including module: $module\n");
                    system("cd $path; cp -rap . $tmpdir/");
                } else {
                    &dprint("Defined module not found: $module\n");
                }
            }
            my $tmpinitramfs = "/tftpboot/wwinitramfs-$kversion_safe";
            system("cp $wwinitramfs $tmpinitramfs");
            system("cd $tmpdir; find . | cpio -o --quiet -H newc -A -F $tmpinitramfs");
            &iprint("Compressing the initramfs\n");
            system("gzip -f -9 $tmpinitramfs");
            system("rm -rf $tmpdir/*");
            &iprint("Extracting the kernel object\n");
            system("rpm2cpio $rpm | (cd $tmpdir; cpio --quiet -id */boot/vmlinuz-*)");
            system("cp $tmpdir/boot/vmlinuz-* /tftpboot/");
            system("rm -rf $tmpdir");
        }
    }
} else {
    die "This program only understands RPM files at the moment\n";
}






