#!/bin/sh
#
# Copyright (c) 2001-2003 Gregory M. Kurtzer
#
# Copyright (c) 2003-2011, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.
#


> $NEWROOT/etc/mtab


if [ -z "$WWNOFSTABUPDATE" ]; then
    if [ -f "$NEWROOT/etc/fstab" ]; then
        cat /tmp/fstab > $NEWROOT/etc/fstab_
        echo "# The following was added by Warewulf provision (setup-filesystem)" > $NEWROOT/etc/fstab_
        echo >> $NEWROOT/etc/fstab_
        cat $NEWROOT/etc/fstab >> $NEWROOT/etc/fstab_
        echo "# Below is the original fstab content in the VNFS image" >> $NEWROOT/etc/fstab_
        echo >> $NEWROOT/etc/fstab_
        cat $NEWROOT/etc/fstab >> $NEWROOT/etc/fstab_
        cat $NEWROOT/etc/fstab_ > $NEWROOT/etc/fstab
        rm -f $NEWROOT/etc/fstab_
    else
        cp /tmp/fstab $NEWROOT/etc/fstab
    fi
fi


grep -v "^none" /tmp/mptab | sort | while read mp dev type opts freq passno; do
    if [ "x$mp" == "x/" ]; then
        mount -o remount,ro $NEWROOT/
    else
        if ! umount $NEWROOT/$mp; then
            mount -o remount,ro $NEWROOT/$mp
        fi
    fi
done

