#!/bin/sh
#
# Copyright (c) 2001-2003 Gregory M. Kurtzer
#
# Copyright (c) 2003-2011, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.
#

if [ -z "$WWMOUNT" ]; then
    WWMOUNT="dev=none:mountpoint=/:type=tmpfs:options=size=768M"
fi

#WWPART="sda"
#WWFORMAT="sda1 sda2 sda3"
#WWMOUNT="dev=sda1:mountpoint=/:type=ext2:size=768 dev=sda2:type=swap:size=1024 dev=sda3:mountpoint=/foo:type=ext2:size=10240"

TMPDIR=`mktemp -d`
mkdir $TMPDIR/wwfs
> /tmp/fstab
> /tmp/mptab
> /tmp/mtab

if [ -n "$NEWROOT" ]; then
    if [ ! -d $NEWROOT ]; then
        mkdir -p $NEWROOT
    fi
fi


for FSYS in `echo $WWMOUNT | sed 's/,/ /g'` ; do
    ( 
        TMPFILE=`mktemp`
        for SETVAR in `echo $FSYS | sed 's/:/ /g'` ; do
            VAR=`echo $SETVAR | cut -d= -f1 | tr '[a-z]' '[A-Z]'`
            VAL=`echo $SETVAR | cut -d= -f2-`
            eval "WWFS_$VAR=$VAL"
            echo "WWFS_$VAR=$VAL" >> $TMPFILE
            echo "export WWFS_$VAR" >> $TMPFILE
        done
        if [ -n "$WWFS_DEV" ]; then
            DISK=`echo $WWFS_DEV | sed -e 's@\([a-z]*\)[0-9]@\1@'`
            mv $TMPFILE $TMPDIR/wwfs/$WWFS_DEV
            if [ -n "$DISK" ]; then
                echo "$WWFS_DEV" >> $TMPDIR/$DISK
            fi
            if [ -n "$WWFS_DEV" -o "$WWFS_DEV" == "none" ]; then
                DEV="none"
            else
                DEV="/dev/$WWFS_DEV"
            fi
            if [ -n "$WWFS_TYPE" ]; then
                if [ "x$WWFS_MOUNTPOINT" == "x/" ]; then
                    echo "$WWFS_MOUNTPOINT $DEV $WWFS_TYPE ${WWFS_OPTIONS:-defaults} 0 0" >> /tmp/mptab
                else
                    echo "${WWFS_MOUNTPOINT:-none} $DEV $WWFS_TYPE ${WWFS_OPTIONS:-defaults} 1 2" >> /tmp/mptab
                fi
            fi
        else
            rm -f $TMPFILE
        fi
    )
done

for DEV in `echo $WWPART | sed 's/,/ /g'` ; do
    (
        if [ -f "$TMPDIR/$DEV" ]; then
            cat $TMPDIR/$DEV | while read part; do
                if [ -f "$TMPDIR/wwfs/$part" ]; then
                    . $TMPDIR/wwfs/$part
                    if [ -n "$WWFS_DEV" ]; then
                        PARTNUM=`echo $WWFS_DEV | sed -e 's@...\([0-9]\)@\1@'`
                        DISK=`echo $WWFS_DEV | sed -e 's@\([a-z]*\)[0-9]@\1@'`
                        if [ -n "$WWFS_SIZE" ]; then
                            case $WWFS_TYPE in
                                swap)
#                                    echo -ne "n\np\n$PARTNUM\n$WWFS_START\n$WWFS_SIZE\nt\n$PARTNUM\n82\nw\n"
                                    echo -ne "n\np\n$PARTNUM\n$WWFS_START\n$WWFS_SIZE\nt\n$PARTNUM\n82\nw\n" | /sbin/fdisk /dev/$DISK > /dev/null || exit 255
                                ;;
                                *)
#                                    echo -ne "n\np\n$PARTNUM\n$WWFS_START\n$WWFS_SIZE\nw\n"
                                    echo -ne "n\np\n$PARTNUM\n$WWFS_START\n$WWFS_SIZE\nw\n" | /sbin/fdisk /dev/$DISK > /dev/null || exit 255
                                ;;
                            esac
                        fi
                    fi
                fi
            done
        fi
    )
done

for DEV in `echo $WWFORMAT | sed 's/,/ /g'` ; do
    (
        if [ -f "$TMPDIR/wwfs/$DEV" ]; then
            . $TMPDIR/wwfs/$DEV
            case $WWFS_TYPE in
                swap)
                    /sbin/mkswap /dev/$WWFS_DEV
                ;;
                ext2)
                    /sbin/mkfs.ext2 /dev/$WWFS_DEV
                ;;
            esac
        fi
    )
done


grep -v "^none" /tmp/mptab | sort -r | while read mp dev type opts freq passno; do
    echo "$dev $mp $type $opts $freq $passno" >> /tmp/fstab
    if mount -o $opts -t $type $dev $NEWROOT/$mp; then
        echo "$dev $mp $type $opts $freq $passno" >> /tmp/mtab
    fi
done

grep "^none" /tmp/mptab | sort -r | while read mp dev type opts freq passno; do
    echo "$dev $mp $type $opts $freq $passno" >> /tmp/fstab
done

rm -rf $TMPDIR
