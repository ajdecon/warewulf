#!/bin/sh
#
# Copyright (c) 2003-2010, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of any
# required approvals from the U.S. Dept. of Energy).  All rights reserved.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# The GNU GPL Document can be found at:
# http://www.gnu.org/copyleft/gpl.html
#


mkdir /proc 2>/dev/null
mkdir /sys  2>/dev/null
mkdir /tmp  2>/dev/null
mkdir /var  2>/dev/null
mkdir /usr  2>/dev/null

mount -t proc none /proc
mount -t sysfs none /sys

. /etc/functions


dmesg -n 1 >/dev/null 2>&1

clear

msg_blue "Welcome to Warewulf!\n"
echo

if [ -n "$WWNODE" ]; then
    msg_white "Setting Hostname: "
    msg_gray "$WWNODE\n"
    hostname $WWNODE
fi

if [ -x "/sbin/mdev" ]; then
   echo /sbin/mdev > /proc/sys/kernel/hotplug
   /sbin/mdev -s
fi

msg_white  "Loading drivers: "

for module in `/sbin/detect | sort | uniq`; do
    msg_gray " $module"
    modprobe $module
done

echo

ifup() {
    DEVICE=$1
    if [ -n "$WWIP" -a -n "$WWNETMASK" ]; then
        if ifconfig $DEVICE up >/dev/null 2>&1; then
            msg_white  "Configuring $DEVICE: "
            msg_gray "$WWIP/$WWNETMASK\n"
            ifconfig $DEVICE $WWIP netmask $WWNETMASK up
            RETVAL=$?
        fi
    else
        if ifconfig $DEVICE up >/dev/null 2>&1; then
            msg_white "Configuring $DEVICE: "
            msg_gray "DHCP\n"
            sleep 2
            udhcpc --now -i $DEVICE -t 5 -s /sbin/dhcp-script >/dev/null
            RETVAL=$?
        fi
    fi
    return $RETVAL
}


if [ -n "$WWDEV" ]; then
    for i in $WWDEV; do
        ifup $i
    done
else
    for i in eth0 eth1 eth2 eth3 eth4; do
        ifup $i
    done
fi



for i in /etc/warewulf/init/*; do
    if [ -x "$i" -a -f "$i" ]; then
        sh $i
    fi
done



msg_white "Connecting to Warewulf master: "
msg_gray "$WWCGI\n"
echo "-------------------------------------------------------------------------------"

while true; do
    wget -q -O - $WWCGI 2>/dev/null | /bin/sh
    sleep 5
done


